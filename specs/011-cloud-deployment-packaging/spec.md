# Feature Specification: 云端部署与客户端打包

**Feature Branch**: `011-cloud-deployment-packaging`
**Created**: 2025-10-27
**Status**: Draft
**Input**: User description: "使用中文对话，帮我把该项目打包部署，要求：1. 后端可以单独打包，部署到aws上面 2. 前端打包成mac客户端，支持本地模式和云端模式，本地模式直接与本地文件交互，云端模式调用aws部署的后端"

## Clarifications

### Session 2025-10-27

- Q: AWS 部署后的 API 访问方式 → A: AWS 部署后要配置域名，保证合法访问，并将后端 URL 固定下来，所有客户端的云端模式都访问此 URL
- Q: 客户端默认模式和 URL 配置能力 → A: 客户端安装后默认访问云端模式，统一访问部署在 AWS 的 URL，用户不能自定义 URL
- Q: 域名和 HTTPS 配置方式 → A: 使用 AWS 默认 URL（如 xxx.elb.amazonaws.com），仅使用 HTTPS，不配置自定义域名
- Q: 用户认证方式 → A: 必须注册/登录 - 用户需要创建账号并登录后才能使用云端服务
- Q: 用户数据隔离级别 → A: 多租户架构 - 所有用户共享同一个数据库，数据按用户 ID 隔离，使用 Supabase Auth 实现认证
- Q: 部署后的监控和日志 → A: 最小监控 - 仅健康检查端点，无日志聚合
- Q: 客户端更新分发方式 → A: GitHub Releases - 通过 GitHub Releases 页面分发客户端更新

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 后端云端部署 (Priority: P1)

运维人员需要将后端服务独立部署到 AWS 云平台，使其能够为云端模式的客户端提供 API 服务。后端部署完成后，应该获得一个稳定的 API 端点地址，供客户端配置使用。

**Why this priority**: 这是整个双模式架构的基础设施。没有云端后端，云端模式无法运行。后端必须首先部署成功，才能进行客户端的云端模式测试。

**Independent Test**: 可以通过向部署的 API 端点发送健康检查请求来独立验证后端部署是否成功，无需依赖客户端。

**Acceptance Scenarios**:

1. **Given** 后端代码已准备好部署, **When** 运维人员执行部署命令, **Then** 后端服务成功部署到 AWS 并返回可访问的 API 端点 URL
2. **Given** 后端已部署到 AWS, **When** 发送健康检查请求到 API 端点, **Then** 返回 200 状态码表示服务正常运行
3. **Given** 后端已部署, **When** 通过 API 端点访问任意现有功能（如获取知识库列表）, **Then** 返回正确的数据响应
4. **Given** 数据库连接配置正确, **When** 后端启动, **Then** 成功连接到 PostgreSQL 数据库并可执行查询
5. **Given** 环境变量配置完整, **When** 后端服务运行, **Then** 所有依赖的云端服务（如 Supabase Storage）正常工作

---

### User Story 2 - Mac 客户端本地模式打包 (Priority: P1)

终端用户需要下载并安装 Mac 客户端应用。客户端默认以云端模式启动，但用户可以切换到本地模式，在完全离线的环境下使用 rafa 的所有功能，数据存储在本地文件系统。

**Why this priority**: 本地模式是 rafa 的核心竞争力之一（隐私保护、离线可用）。P1 优先级确保基础的本地功能可以独立交付给需要隐私保护的用户。

**Independent Test**: 可以在断网环境下安装并运行客户端，创建笔记、知识库等功能，验证所有数据都保存在本地文件系统中，无需云端连接。

**Acceptance Scenarios**:

1. **Given** 用户下载了 Mac 客户端安装包, **When** 双击安装包并完成安装流程, **Then** 应用图标出现在应用程序文件夹中
2. **Given** 客户端已安装, **When** 用户首次启动应用, **Then** 应用默认以云端模式启动，自动连接到预配置的云端 API
3. **Given** 应用在云端模式运行, **When** 用户打开设置并切换到本地模式, **Then** 应用以本地模式运行
4. **Given** 应用以本地模式运行, **When** 用户创建笔记或知识库, **Then** 数据保存在用户本地文件系统（如 ~/Library/Application Support/rafa）
5. **Given** 本地模式下的数据已保存, **When** 用户重启应用, **Then** 之前创建的数据正确加载显示
6. **Given** 用户在完全离线状态切换到本地模式, **When** 使用本地 AI 功能（Ollama）, **Then** 聊天、知识库问答等功能正常工作

---

### User Story 3 - Mac 客户端云端模式使用 (Priority: P2)

终端用户安装客户端后，默认使用云端模式访问统一的云端服务，享受跨设备同步和强大的 AI 模型能力。用户可以在本地模式和云端模式之间自由切换，而不会丢失任何数据。

**Why this priority**: 云端模式提供跨设备同步和更强大的 AI 模型访问能力。作为默认模式，确保大部分用户开箱即用。P2 优先级允许先完成基础功能，再优化用户体验。

**Independent Test**: 可以在客户端默认启动云端模式后，验证能够正常访问云端数据和服务，无需任何配置。

**Acceptance Scenarios**:

1. **Given** 客户端首次安装且用户未登录, **When** 用户启动应用, **Then** 自动以云端模式启动，显示注册/登录界面
2. **Given** 用户在登录界面, **When** 用户完成注册或登录, **Then** 成功连接到预配置的云端 API 并进入主界面
3. **Given** 用户已登录云端模式, **When** 用户创建笔记或知识库, **Then** 数据保存到云端数据库（通过 API 调用）
4. **Given** 用户已登录云端模式, **When** 用户重启应用, **Then** 自动登录并显示云端数据
5. **Given** 客户端正在云端模式运行, **When** 用户打开设置并选择本地模式, **Then** 应用切换到本地模式
6. **Given** 客户端配置为本地模式, **When** 用户切换回云端模式, **Then** 显示云端数据，本地数据不受影响
7. **Given** 云端 API 不可达（如断网）, **When** 客户端以云端模式启动, **Then** 显示清晰的错误提示并建议切换到本地模式

---

### User Story 4 - 部署流程自动化 (Priority: P3)

开发团队需要自动化的部署流程，能够通过简单的命令完成后端打包、部署到 AWS，以及客户端打包、上传到 GitHub Releases 的全过程，减少手动操作和人为错误。

**Why this priority**: 自动化部署提高开发效率，但不影响终端用户使用。可以在手动部署验证成功后再进行自动化优化。

**Independent Test**: 可以运行部署脚本，验证是否自动完成构建、上传、部署等步骤，无需手动干预。

**Acceptance Scenarios**:

1. **Given** 开发人员修改了后端代码, **When** 执行后端部署命令, **Then** 自动完成代码构建、Docker 镜像打包、上传到 AWS
2. **Given** 开发人员修改了客户端代码, **When** 执行客户端构建命令, **Then** 自动完成客户端打包生成 .dmg 文件
3. **Given** 客户端 .dmg 文件已生成, **When** 执行发布命令, **Then** 自动创建 GitHub Release 并上传 .dmg 文件
4. **Given** 部署脚本执行中, **When** 出现错误（如构建失败）, **Then** 脚本停止执行并显示清晰的错误信息
5. **Given** 部署成功完成, **When** 查看部署日志, **Then** 显示详细的部署步骤和最终的 API 端点地址或 GitHub Release 链接

---

### Edge Cases

- **断网情况下的模式切换**: 用户在云端模式下突然断网，应该显示离线提示并建议切换到本地模式，不应导致应用崩溃
- **云端 API 不可达**: 客户端以云端模式启动时，如果无法连接到预配置的云端 API，应显示清晰的错误信息（如"无法连接到服务器，请检查网络或切换到本地模式"）
- **本地数据迁移到云端**: 本地模式和云端模式的数据完全隔离，不提供自动迁移功能。用户切换模式后看到的是对应模式的独立数据集
- **Mac 系统版本兼容性**: 客户端支持 macOS 12 (Monterey) 及以上版本
- **后端更新后的客户端兼容性**: 客户端启动时检查后端 API 版本，如果版本不兼容则显示更新提示（用户可选择跳过或下载新版本）
- **旧版本客户端降级使用**: 用户选择跳过更新提示后，如果 API 版本差异较大导致功能异常，应显示友好的错误提示而非崩溃
- **后端 URL 变更**: 如果云端后端部署的 URL 发生变更，需要发布新版本客户端并提示用户更新
- **用户登录失败**: 用户在登录界面多次输入错误密码，应该显示友好的错误提示并提供密码重置选项
- **登录状态过期**: 用户长时间未使用应用后再次启动，如果登录令牌过期，应该提示重新登录而非直接报错

## Requirements _(mandatory)_

### Functional Requirements

#### 后端部署相关

- **FR-001**: 系统必须提供后端独立打包能力，能够将后端代码打包成可部署的格式（如 Docker 镜像或 Node.js 应用包）
- **FR-002**: 系统必须支持将后端部署到 AWS 平台（如 EC2、ECS、Lambda 或 Elastic Beanstalk）
- **FR-003**: 部署的后端必须暴露 HTTPS RESTful API 端点（使用 AWS 默认域名，如 xxx.elb.amazonaws.com），供客户端调用
- **FR-004**: 后端部署必须包含健康检查端点（如 /health 或 /api/health），用于监控服务状态（这是唯一的监控方式）
- **FR-005**: 后端部署必须支持环境变量配置（如数据库连接字符串、Supabase 密钥、CORS 设置等）
- **FR-006**: 部署的后端必须能够连接到云端 Supabase 服务（包括 PostgreSQL 数据库、Storage 和 Auth）
- **FR-030**: 部署的后端 API URL 必须在部署完成后固定下来，作为所有客户端的统一云端访问端点
- **FR-038**: 后端部署必须配置 Supabase 项目的连接信息（URL、匿名密钥、服务密钥等）

#### 客户端打包相关

- **FR-007**: 系统必须能够将前端代码打包成 macOS 原生应用程序（.app 格式或 .dmg 安装包）
- **FR-008**: 打包的客户端必须是自包含的（包含所有依赖，无需用户额外安装 Node.js 或其他运行时）
- **FR-009**: 客户端必须支持本地模式，在此模式下所有数���存储在用户本地文件系统
- **FR-010**: 客户端必须支持云端模式，在此模式下所有数据通过 API 调用保存到云端后端
- **FR-011**: 客户端必须提供模式切换功能，用户可以在设置中选择本地模式或云端模式
- **FR-012**: 客户端安装后必须默认以云端模式启动，自动连接到预配置的统一云端 API URL
- **FR-031**: 客户端必须在构建时将云端 API URL 硬编码到应用中，用户不能修改此 URL
- **FR-032**: 云端 API URL 必须使用 HTTPS 协议确保数据传输安全

#### 本地模式特定需求

- **FR-013**: 本地模式必须使用本地 SQLite 数据库存储结构化数据（笔记、知识库元数据等）
- **FR-014**: 本地模式必须使用本地文件系统存储文件（知识库文档、上传的附件等）
- **FR-015**: 本地模式必须支持 Ollama 本地 AI 模型（已有的 electron-ollama 集成）
- **FR-016**: 本地模式下，应用必须能够在完全离线的环境下正常运行所有核心功能

#### 云端模式特定需求

- **FR-017**: 云端模式必须通过配置的 API 端点调用后端 API 进行所有数据操作
- **FR-018**: 云端模式必须处理网络错误（如 API 不可达、超时），并向用户显示清晰的错误提示
- **FR-019**: 云端模式必须验证 API 连接在切换模式时（显示连接测试结果）
- **FR-020**: 云端模式必须支持云端 AI 模型（如 OpenAI、Anthropic 等已集成的模型）
- **FR-033**: 云端模式必须要求用户通过 Supabase Auth 注册账号并登录后才能访问云端服务
- **FR-034**: 用户首次以云端模式启动时，如果未登录，必须显示注册/登录界面
- **FR-035**: 用户登录凭证（Supabase Auth Token）必须安全存储在本地，支持自动登录（记住登录状态）
- **FR-036**: 所有云端数据必须与用户账号关联，确保多租户架构下的数据隔离（按用户 ID 隔离）
- **FR-037**: 后端 API 必须验证每个请求的 Supabase Auth Token，确保用户只能访问自己的数据

#### 数据隔离

- **FR-021**: 本地模式和云端模式的数据必须完全隔离，切换模式时不会相互覆盖数据
- **FR-022**: 用户在切换模式时，系统必须清晰提示当前查看的是哪种模式的数据
- **FR-023**: 系统不提供本地数据到云端的自动迁移功能，两种模式的数据独立维护

#### 版本兼容性

- **FR-024**: 客户端必须在启动时检查后端 API 版本（通过版本端点如 /api/version）
- **FR-025**: 当检测到客户端版本与后端 API 版本不兼容时，必须显示更新提示对话框
- **FR-026**: 更新提示对话框必须允许用户选择"立即更新"或"跳过"
- **FR-027**: 用户选择跳过更新后，如果使用过程中出现 API 兼容性错误，必须显示友好的错误提示（而非应用崩溃）
- **FR-039**: 更新提示对话框中的"立即更新"按钮必须引导用户到 GitHub Releases 页面下载最新版本

#### 系统兼容性

- **FR-028**: 打包的客户端必须支持 macOS 12 (Monterey) 及以上版本
- **FR-029**: 在不支持的 macOS 版本上启动时，必须显示清晰的系统要求提示

### Key Entities

- **部署配置 (Deployment Configuration)**: 包含 AWS 部署所需的配置信息（区域、实例类型、环境变量、数据库连接等）
- **API 端点 (API Endpoint)**: 后端部署成功后生成的唯一 HTTPS URL（AWS 默认域名），所有客户端统一访问此端点
- **用户账号 (User Account)**: 用户在云端服务的注册账号，包含身份信息、登录凭证，用于访问和管理云端数据
- **认证令牌 (Authentication Token)**: 用户登录后生成的安全令牌，存储在客户端本地，用于后续 API 请求的身份验证
- **版本信息 (Version Information)**: 包含客户端版本号和后端 API 版本号，用于兼容性检查
- **客户端配置 (Client Configuration)**: 客户端应用的设置，包含当前模式（本地/云端）、登录状态、本地数据路径等
- **本地数据存储 (Local Data Storage)**: 本地模式下的 SQLite 数据库文件和文件系统目录，包含所有本地模式的数据
- **云端数据存储 (Cloud Data Storage)**: 云端模式下通过 API 访问的 PostgreSQL 数据库和 Supabase Storage，包含所有云端模式的数据（与用户账号关联）

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 后端部署完成后，健康检查端点在 95% 的时间内响应时间低于 500ms
- **SC-002**: 运维人员能够在 30 分钟内完成从代码提交到 AWS 部署上线的全过程
- **SC-003**: Mac 客户端安装包大小控制在 200MB 以内（不包含 Ollama 模型），下载和安装时间在 5 分钟内完成
- **SC-004**: 用户能够在 10 秒内完成从本地模式切换到云端模式（或反向切换）
- **SC-005**: 本地模式下，应用在完全离线状态下，所有核心功能（笔记、知识库、AI 聊天）100% 可用
- **SC-006**: 云端模式下，API 调用的平均响应时间低于 1 秒（在正常网络条件下）
- **SC-007**: 90% 的用户能够在首次使用时成功注册/登录并连接到云端服务
- **SC-008**: 客户端打包成功率达到 100%（每次构建都能生成可安装的 .app 或 .dmg 文件）
- **SC-009**: 后端部署成功率达到 95% 以上（排除网络或 AWS 服务故障）
- **SC-010**: 用户在切换模式时，0% 的概率出现数据丢失或数据混淆的情况

## Assumptions

1. **AWS 部署方式**: 假设使用 AWS ECS (Elastic Container Service) + Fargate 进行 Docker 容器部署，这是无服务器且易于管理的方案。如有特定偏好（如 EC2 或 Lambda），需要明确说明。

2. **Supabase 项目**: 假设 Supabase 项目已经创建并配置完成（包括数据库 Schema、Auth 设置、Storage Bucket 等），部署流程仅需配置连接信息。

3. **客户端签名**: 假设 Mac 客户端打包暂不进行代码签名（未签名的应用在首次打开时需要用户在"系统偏好设置"中允许）。如需签名需要 Apple Developer 账号和证书。

4. **本地数据路径**: 假设本地模式的数据默认保存在 `~/Library/Application Support/rafa/`，用户无法自定义路径（简化实现）。

5. **模式切换无缝性**: 假设用户需要手动重启应用来完成模式切换（而非热切换），以确保数据隔离的正确性。

6. **网络要求**: 假设用户在配置云端模式时有稳定的网络连接。本地模式不依赖网络。

7. **macOS 版本**: 客户端支持 macOS 12 (Monterey) 及以上版本，覆盖约 70% 的 Mac 用户。

8. **数据迁移**: 本地模式和云端模式的数据完全隔离，不提供自动迁移功能。如果用户需要在两种模式间迁移数据，需要手动导出/导入（如导出为文件后重新上传）。

9. **版本兼容性策略**: 采用语义化版本号（Semantic Versioning），客户端和后端 API 使用主版本号（major version）判断兼容性。主版本号不同时显示更新提示，但允许用户跳过。

10. **更新机制**: 更新提示仅为引导性质，不包含自动下载和安装功能。用户需要手动从 GitHub Releases 下载新版本并重新安装。

11. **用户认证方式**: 使用 Supabase Auth 提供的邮箱+密码认证方式，不包含 OAuth 社交登录（如 Google、GitHub 等）或多因素认证（MFA）。

12. **多租户数据隔离**: 所有用户数据通过 Supabase Row Level Security (RLS) 策略进行隔离，确保用户只能访问自己的数据。

13. **监控和运维**: 采用最小监控策略，仅通过健康检查端点监控服务可用性，不实施日志聚合、指标监控或告警系统，以降低运维复杂度和成本。

14. **客户端分发**: 通过 GitHub Releases 公开分发客户端，假设项目仓库是公开的（或至少 Releases 页面可公开访问）。不使用 Mac App Store 或私有分发渠道。
