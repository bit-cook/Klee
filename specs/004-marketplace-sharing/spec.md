# 功能规格说明：市场商店分享功能

**功能分支**: `004-marketplace-sharing`
**创建日期**: 2025-10-19
**状态**: 草稿
**输入**: 用户描述："参考knowledge base的结构，增加market place功能，主要如下：
1. marketplace有agent，knowledge base，local llms，cloud llms四个模块，其中local llms，cloud llms两个模块此次修改不要涉及，后边会单独处理
2. marketplace里面的knowledge base就是用户创建好的knowledge base，分享之后，在此处展示，其他用户可以直接选择使用
3. agent的概念就是chat config的字段，本质就是可以把自己的配置分享给其他人用，具体字段有name，descrption（系统提示词），llm和knowledge base，UI中的instructions去掉
4. UI已经定好，有初始首页，也有创建页面，在此基础调整，非必要不要修改我的UI"

## 澄清记录

### 会话 2025-10-19

- Q: 从 Chat 创建 Agent 时，配置应该从哪里获取？ → A: 从 ChatSession 自身字段获取（model、systemPrompt、webSearchEnabled、availableKnowledgeBaseIds）
- Q: Agent 头像如何处理？ → A: 在 ChatConfig 表添加 avatar 字段（存储头像 URL 或 emoji）
- Q: 从 Chat 创建 Agent 的工作流程？ → A: 跳转到 Agent 创建页面，表单预填充当前 chat 配置（用户补充头像、调整后保存）
- Q: Agent 安装后的知识库关联处理？ → A: 知识库都在云端，可以直接使用，不需要安装。安装 Agent 时直接复制知识库引用，用户可立即使用
- Q: 知识库分享的权限控制？ → A: 分享后所有用户都可以访问和使用该知识库（公开只读访问）
- Q: 分享的 Agent 和知识库能否修改或删除？ → A: 一旦分享，项目变为不可变且永久公开（无法取消分享、修改或删除）
- Q: 知识库的 name 和 description 字段如何处理？ → A: knowledgeBase 表需要新增 name 和 description 字段，分享时用户填写
- Q: 不可修改/删除的限制范围？ → A: 仅已分享项目（isPublic = true）不可修改/删除，未分享项目可以正常修改和删除
- Q: 从 Chat 创建 Agent 时跳转的路由是什么？ → A: 跳转到 /marketplace/agent/new 创建页面，提交后跳转到详情页
- Q: 知识库分享时跳转到哪个页面？ → A: 跳转到专用分享页面 /marketplace/knowledge-base/:id/share，填写 name 和 description 后提交

## 用户场景与测试 *(必填)*

### 用户故事 1 - 从 Chat 快速创建 Agent (优先级: P1)

用户在聊天过程中调整好配置后，可以通过 Chat 页面右侧边栏的 "Share & Create Agent" 按钮，快速将当前 chat 的配置（模型、系统提示词、知识库等）转换为可复用的 Agent。

**优先级理由**: 这是用户创建 Agent 的主要入口和最自然的工作流程。用户在实际使用中验证配置效果后，可以立即保存为 Agent 供后续使用或分享，这大大降低了创建门槛。

**独立测试**: 可以通过在 Chat 中调整配置，点击 "Share & Create Agent" 按钮，验证配置是否正确预填充到创建页面，补充头像和调整后成功创建 Agent。成功的标准是：所有 chat 配置正确传递，创建的 Agent 可以在配置列表中找到。

**验收场景**:

1. **假设** 用户正在 Chat 页面对话，**当** 用户点击右侧边栏的 "Share & Create Agent" 按钮时，**那么** 跳转到 /marketplace/agent/new 页面，表单预填充当前 chat 的配置（model、systemPrompt、webSearchEnabled、知识库列表）
2. **假设** 用户在 Agent 创建页面填写完整信息，**当** 点击创建时，**那么** 成功创建新的 ChatConfig 并跳转到 Agent 详情页
3. **假设** 当前 chat 关联了多个知识库，**当** 跳转到创建页面时，**那么** 所有关联的知识库都正确预选中
4. **假设** 用户在创建页面修改了配置，**当** 点击取消时，**那么** 返回原 chat 页面，不创建 Agent
5. **假设** Chat 的 systemPrompt 为空，**当** 跳转到创建页面时，**那么** description 字段为空，提示用户填写

---

### 用户故事 2 - 分享 Agent 配置到市场 (优先级: P1)

用户可以将自己创建的 ChatConfig（Agent 配置）发布到市场，供其他用户发现和使用。Agent 包含名称、头像、描述（系统提示词）、LLM 模型和关联的知识库等配置。

**优先级理由**: 这是市场分享功能的核心价值。用户能够分享自己精心调配的 Agent，并且其他用户可以直接使用这些配置，大大提高了配置的复用性和社区价值。

**独立测试**: 可以通过创建一个 ChatConfig，将其发布到市场，然后在市场页面验证该 Agent 是否正确显示来完整测试。成功的标准是：Agent 信息完整显示，包含作者信息、名称、描述、关联的 LLM 和知识库。

**验收场景**:

1. **假设** 用户已创建 ChatConfig（包含头像），**当** 用户选择"分享到市场"操作时，**那么** Agent 被发布到市场，isPublic 标记为 true，生成唯一的 shareSlug
2. **假设** 用户发布 Agent，**当** 发布成功时，**那么** 市场的 Agents 标签页立即显示该 Agent，包含头像、作者、名称、描述、LLM 模型
3. **假设** Agent 关联了多个知识库，**当** Agent 显示在市场时，**那么** 所有关联的知识库名称都正确显示
4. **假设** 用户已发布 Agent 到市场，**当** 用户尝试修改或删除该 Agent 时，**那么** 系统禁止修改和删除操作，显示提示"已分享的 Agent 无法修改或删除"
5. **假设** 用户分享前预览 Agent，**当** 确认分享时，**那么** 显示"分享后无法修改或删除"的警告，要求用户二次确认

---

### 用户故事 3 - 分享知识库到市场 (优先级: P1)

用户可以将自己创建的知识库发布到市场，供其他用户直接引用和使用。所有知识库都在云端，分享后其他用户可以在 Agent 中直接使用，无需安装。分享时需要填写知识库的名称和描述。

**优先级理由**: 知识库分享是市场的第二个核心功能。用户可以分享专业领域的知识库，其他用户可以直接在 Agent 中引用使用，形成知识共享生态。与 Agent 分享同等重要。

**独立测试**: 可以通过创建知识库，上传文件，填写名称和描述后发布到市场，然后在市场验证知识库是否正确显示并可被其他用户访问来完整测试。成功的标准是：知识库信息完整显示，包含作者、名称、描述、文件数量，其他用户可以在 Agent 中引用该知识库。

**验收场景**:

1. **假设** 用户已创建知识库并上传文件，**当** 用户点击"分享到市场"按钮时，**那么** 跳转到 /marketplace/knowledge-base/:id/share 页面，显示表单要求填写 name 和 description
2. **假设** 用户在分享页面填写完整信息，**当** 提交分享时，**那么** 知识库被发布到市场，设置 isPublic = true 并生成唯一 shareSlug，然后跳转到市场知识库详情页
3. **假设** 用户发布知识库，**当** 发布成功时，**那么** 市场的 Knowledge Bases 标签页立即显示该知识库，包含填写的名称和描述
4. **假设** 知识库包含多个文件，**当** 知识库显示在市场时，**那么** 显示文件数量统计信息
5. **假设** 用户已发布知识库到市场，**当** 用户尝试修改或删除该知识库时，**那么** 系统禁止修改和删除操作，显示提示"已分享的知识库无法修改或删除"
6. **假设** 用户在分享页面，**当** 点击提交前，**那么** 显示"分享后无法修改或删除"的警告，要求用户二次确认

---

### 用户故事 4 - 从市场安装使用 Agent (优先级: P1)

用户可以浏览市场中的 Agent，选择感兴趣的 Agent 并将其安装到自己的账户中使用。

**优先级理由**: 这是市场分享功能的完整闭环。如果用户只能发布但不能使用，市场就失去了价值。安装和使用与发布同等重要。

**独立测试**: 可以通过浏览市场 Agent，点击安装，然后在聊天配置列表中验证 Agent 是否成功添加来完整测试。成功的标准是：安装的 Agent 出现在用户配置列表中，所有配置参数正确复制。

**验收场景**:

1. **假设** 用户浏览市场 Agents 标签页，**当** 用户点击某个 Agent 查看详情时，**那么** 显示完整的 Agent 信息，包括头像、名称、作者、描述、LLM 模型、关联知识库
2. **假设** 用户查看 Agent 详情，**当** 用户点击"安装"或"使用"按钮时，**那么** 创建该 Agent 的副本到用户自己的 ChatConfig 列表，包含所有配置和知识库引用
3. **假设** Agent 关联了知识库，**当** 用户安装 Agent 时，**那么** 知识库引用直接复制到新 ChatConfig，用户可以立即使用这些云端知识库
4. **假设** 用户已安装过某个 Agent，**当** 用户再次查看该 Agent 时，**那么** 显示"已安装"状态，并提供"重新安装"选项（创建新副本）
5. **假设** 市场中的 Agent 永久可用，**当** 用户通过 shareSlug 访问 Agent 时，**那么** 始终能够查看和安装该 Agent（已分享项目不可删除）

---

### 用户故事 5 - 市场浏览和搜索 (优先级: P2)

用户可以在市场首页浏览所有公开的 Agent 和知识库，使用搜索功能快速找到感兴趣的内容。

**优先级理由**: 浏览和搜索是提升用户体验的功能，但在市场初期，内容较少时，简单的列表展示已足够。可以在内容丰富后优先级提升。

**独立测试**: 可以通过访问市场首页，切换不同标签页，使用搜索框输入关键词来完整测试。成功的标准是：标签页切换流畅，搜索结果准确匹配关键词。

**验收场景**:

1. **假设** 用户访问市场首页，**当** 页面加载时，**那么** 显示所有公开的 Agent 和知识库，按更新时间倒序排列
2. **假设** 用户点击 Agents 标签页，**当** 切换完成时，**那么** 仅显示所有公开的 Agent
3. **假设** 用户点击 Knowledge Bases 标签页，**当** 切换完成时，**那么** 仅显示所有公开的知识库
4. **假设** 用户在搜索框输入关键词，**当** 输入完成时，**那么** 实时过滤显示匹配名称或描述的 Agent 和知识库
5. **假设** 用户切换到 Local LLMs 或 Cloud LLMs 标签页，**当** 切换完成时，**那么** 显示占位内容，提示"功能开发中"

---

### 用户故事 6 - Agent 创建/编辑页面优化 (优先级: P3)

优化 Agent 创建/编辑页面，添加 avatar 头像字段，移除 Instructions 字段，确保与市场分享的字段一致（保留 avatar、name、description、llm、knowledge base）。未分享的 Agent 可以正常编辑和删除。

**优先级理由**: 这是 UI 优化和一致性改进，对核心功能影响较小。可以在核心分享和安装功能完成后进行优化。

**独立测试**: 可以通过访问 Agent 创建页面，验证表单字段是否符合要求来完整测试。成功的标准是：表单包含 avatar、name、description、llm、knowledge base 五个字段，且所有字段正常工作。

**验收场景**:

1. **假设** 用户访问 Agent 创建页面，**当** 页面加载时，**那么** 表单显示 avatar 头像选择器，不显示 Instructions 字段
2. **假设** 用户填写 Agent 信息，**当** 提交表单时，**那么** 使用 description 字段作为系统提示词保存到 ChatConfig 的 systemPrompt 字段，avatar 保存到 avatar 字段
3. **假设** 用户编辑未分享的 Agent（isPublic = false），**当** 页面加载时，**那么** 所有字段可正常编辑，description 字段显示原 systemPrompt 的内容
4. **假设** 用户编辑已分享的 Agent（isPublic = true），**当** 尝试修改任何字段时，**那么** 所有字段禁用，显示提示"已分享的 Agent 无法修改"
5. **假设** Agent 表单包含知识库选择器，**当** 用户选择多个知识库时，**那么** 所有选择正确保存到关联表
6. **假设** 用户从 Chat 跳转到创建页面，**当** 页面加载时，**那么** avatar 字段为空待用户选择，其他字段已预填充

---

### 边缘情况

- 当用户尝试分享一个空的知识库（没有文件）会发生什么？→ 系统验证失败，要求至少包含一个已处理完成的文件
- 系统如何处理同一个 Agent 被多个用户同时安装的并发情况？→ 每个安装操作独立创建副本，无并发冲突
- 当 Agent 关联的知识库被原作者删除后，市场中的 Agent 如何显示？→ 知识库一旦分享无法删除，此场景不会发生
- 系统如何处理知识库引用过程中的网络中断或失败？→ 云端知识库无需安装，仅复制引用，操作原子性由数据库事务保证
- 系统如何防止用户重复安装同一个 Agent？→ 允许重复安装，每次创建新的独立副本
- 当市场中的 Agent 或知识库数量超过 1000 个时，如何优化加载性能？→ 使用分页（每页 20 条）和搜索过滤
- 系统如何处理 shareSlug 冲突（两个配置生成相同的 slug）？→ 通过数据库唯一约束保证 slug 唯一性，冲突时自动重新生成
- 当用户尝试修改已分享的 Agent 配置（isPublic = true）会发生什么？→ 系统禁止修改，编辑页面所有字段禁用，显示"已分享的 Agent 无法修改"提示
- 当用户尝试删除已分享的 Agent 或知识库（isPublic = true）会发生什么？→ 系统禁止删除操作，显示"已分享项目无法删除"提示
- 当用户修改或删除未分享的 Agent 或知识库（isPublic = false）会发生什么？→ 正常执行修改或删除操作，无限制
- 当用户分享前配置不完整（缺少必填字段）会发生什么？→ 系统验证失败，提示用户补充必填字段（Agent 需要 name、avatar、systemPrompt、defaultModel；知识库需要 name、description 和至少一个文件）

## 需求 *(必填)*

### 功能需求

**数据模型与持久化**

- **FR-001**: 系统必须在 chatConfigs 表中添加 avatar、isPublic 和 shareSlug 字段，用于存储头像和标识公开分享的 Agent
- **FR-002**: 系统必须在 knowledgeBases 表中添加 name、description、isPublic 和 shareSlug 字段，用于存储知识库元数据和标识公开分享
- **FR-003**: 系统必须为每个分享的 Agent 或知识库生成唯一的 shareSlug，用于市场链接访问
- **FR-004**: 系统必须通过 shareSlug 支持公开访问市场中的 Agent 和知识库详情，无需用户认证

**从 Chat 创建 Agent**

- **FR-005**: 系统必须在 Chat 页面右侧边栏提供 "Share & Create Agent" 按钮
- **FR-006**: 系统必须在用户点击 "Share & Create Agent" 按钮时，跳转到 /marketplace/agent/new 路由并预填充当前 ChatSession 的配置（model、systemPrompt、webSearchEnabled、availableKnowledgeBaseIds）
- **FR-007**: 系统必须在 Agent 创建页面支持用户上传或选择头像（emoji 或图片 URL）
- **FR-008**: 系统必须在用户提交创建表单时，将所有配置保存为新的 ChatConfig 记录，并跳转到该 Agent 的详情页

**Agent 分享功能**

- **FR-009**: 系统必须提供 API 端点，允许用户将自己的 ChatConfig 发布到市场（设置 isPublic = true，一旦分享不可撤销）
- **FR-010**: 系统必须在 Agent 分享时验证配置完整性（必须包含 name、avatar、systemPrompt、defaultModel）
- **FR-011**: 系统必须在分享确认前显示警告："分享后无法修改或删除，确定要分享吗？"
- **FR-012**: 系统必须在市场 Agents 标签页显示所有 isPublic = true 的 ChatConfig
- **FR-013**: 系统必须在 Agent 市场卡片显示头像、作者信息、名称、描述（systemPrompt 的摘要）、LLM 模型
- **FR-014**: 系统必须禁止修改或删除已分享的 Agent（isPublic = true 的 ChatConfig），编辑页面字段禁用并显示提示，删除操作显示错误提示
- **FR-014-1**: 系统必须允许用户正常修改和删除未分享的 Agent（isPublic = false 或 null 的 ChatConfig）

**知识库分享功能**

- **FR-015**: 系统必须提供知识库分享页面路由 /marketplace/knowledge-base/:id/share，允许用户填写 name 和 description 后发布到市场
- **FR-016**: 系统必须提供 API 端点，允许用户将知识库发布到市场（设置 isPublic = true，一旦分享不可撤销）
- **FR-017**: 系统必须在知识库分享时验证必填字段（name、description）和至少包含一个已处理完成的文件（status = 'completed'）
- **FR-018**: 系统必须在分享确认前显示警告："分享后无法修改或删除，确定要分享吗？"
- **FR-019**: 系统必须在分享成功后跳转到市场知识库详情页，显示分享成功的提示
- **FR-020**: 系统必须在市场 Knowledge Bases 标签页显示所有 isPublic = true 的知识库
- **FR-021**: 系统必须在知识库市场卡片显示作者信息、名称、描述、文件数量统计
- **FR-022**: 系统必须允许所有用户访问和使用公开分享的知识库（云端只读访问）
- **FR-023**: 系统必须禁止修改或删除已分享的知识库（isPublic = true），操作时显示明确提示
- **FR-023-1**: 系统必须允许用户正常修改和删除未分享的知识库（isPublic = false 或 null）

**Agent 安装功能**

- **FR-024**: 系统必须提供 API 端点，允许用户从市场安装 Agent 到自己的账户
- **FR-025**: 系统必须在安装 Agent 时复制所有配置字段（name、avatar、systemPrompt、defaultModel、webSearchEnabled）
- **FR-026**: 系统必须在安装 Agent 时直接复制关联的知识库引用到新 ChatConfig（云端知识库无需安装，可立即使用）
- **FR-027**: 系统必须允许用户重复安装同一个 Agent，每次创建新的独立副本
- **FR-028**: 系统必须在已安装的 Agent 记录原始 shareSlug，用于标识来源

**市场浏览与搜索**

- **FR-029**: 系统必须提供 API 端点返回所有公开的 Agent 列表，支持分页（默认每页 20 条）
- **FR-030**: 系统必须提供 API 端点返回所有公开的知识库列表，支持分页（默认每页 20 条）
- **FR-031**: 系统必须支持按名称或描述关键词搜索 Agent 和知识库
- **FR-032**: 系统必须在市场列表按更新时间倒序排列（最新分享的在前）
- **FR-033**: 系统必须为 Local LLMs 和 Cloud LLMs 标签页保留占位 UI，显示"功能开发中"

**UI 调整**

- **FR-034**: 系统必须在 Agent 创建/编辑页面添加 avatar 头像字段，移除 Instructions 字段
- **FR-035**: 系统必须将 Agent 表单的 description 字段映射到 ChatConfig 的 systemPrompt 字段
- **FR-036**: 系统必须在 Agent 表单保留 avatar、name、description、llm、knowledge base 五个字段
- **FR-037**: 系统必须提供知识库分享页面，包含 name、description 输入字段
- **FR-038**: 系统必须在现有 UI 基础上调整，不修改已定义的市场首页和创建页面布局

**缓存与性能**

- **FR-039**: 系统必须使用 TanStack Query 缓存市场 Agent 和知识库列表，staleTime 设置为 2 分钟
- **FR-040**: 系统必须在用户发布分享后自动失效市场列表缓存
- **FR-041**: 系统必须在安装 Agent 后自动失效用户自己的配置列表缓存
- **FR-042**: 系统必须对市场列表 API 实施查询防抖（300ms），避免频繁搜索时的重复请求

### 关键实体

- **Marketplace Agent**: 市场中的 Agent，本质是 isPublic = true 的 ChatConfig，包含头像、作者信息、shareSlug、名称、系统提示词、LLM 模型、关联知识库
- **Marketplace Knowledge Base**: 市场中的知识库，本质是 isPublic = true 的 KnowledgeBase，所有知识库存储在云端，分享后所有用户都可以访问和使用（只读权限）
- **ShareSlug**: 唯一的分享标识符，用于生成公开访问链接（例如 /marketplace/agent/{shareSlug}）
- **Agent Installation**: 用户安装市场 Agent 的操作，创建 ChatConfig 副本（包含头像和所有配置）并记录来源 shareSlug
- **Agent Avatar**: Agent 的头像，可以是 emoji 或图片 URL，存储在 ChatConfig 的 avatar 字段
- **Chat Session Configuration**: ChatSession 自身包含的配置字段（model、systemPrompt、webSearchEnabled、availableKnowledgeBaseIds），用于从 Chat 创建 Agent 时的配置来源
- **Installation Source**: 已安装资源的来源标识，记录原始 shareSlug，用于检测更新和防止重复安装

## 成功标准 *(必填)*

### 可衡量的结果

**分享功能**

- **SC-001**: 用户可以在 3 次点击内完成 Agent 分享操作（配置列表 → 分享按钮 → 确认）
- **SC-002**: 用户可以在 3 次点击内完成知识库分享操作（知识库列表 → 分享按钮 → 确认）
- **SC-003**: Agent 分享操作在 500ms 内完成，市场列表在 1 秒内显示新 Agent
- **SC-004**: 知识库分享操作在 500ms 内完成，市场列表在 1 ���内显示新知识库

**安装功能**

- **SC-005**: 用户可以在 2 次点击内完成 Agent 安装（Agent 详情 → 安装按钮）
- **SC-006**: Agent 安装操作在 1 秒内完成，用户配置列表立即显示新 Agent
- **SC-007**: 知识库安装操作为每 100 个文件提供进度更新，完成时间与文件数量成正比
- **SC-008**: 安装失败时，用户在 3 秒内看到清晰的错误提示和失败原因

**市场浏览**

- **SC-009**: 市场首页在 2 秒内加载完成，显示前 20 个 Agent 和知识库
- **SC-010**: 标签页切换在 200ms 内完成，无明显延迟或闪烁
- **SC-011**: 搜索结果在用户停止输入 300ms 后显示，避免频繁请求
- **SC-012**: 市场支持至少 1000 个 Agent 和 1000 个知识库的流畅浏览（通过分页实现）

**数据一致性**

- **SC-013**: 所有 shareSlug 必须唯一，冲突率为零（通过数据库唯一约束保证）
- **SC-014**: 已分享的 Agent 和知识库必须永久保留在市场，不可删除（isPublic = true 记录不可变）
- **SC-015**: 知识库引用复制的完整性达到 100%（通过事务保证）
- **SC-016**: 已安装的 Agent 作为独立副本，不受原 Agent 任何变化影响

**性能指标**

- **SC-017**: 市场列表 API 响应时间在 500ms 以内（包含数据库查询和数据传输）
- **SC-018**: Agent 详情页加载时间在 300ms 以内
- **SC-019**: 知识库详情页加载时间在 500ms 以内（包含文件列表查询）
- **SC-020**: 系统支持 100 个并发用户同时浏览市场，无性能降级

**用户体验**

- **SC-021**: 90% 的用户能够在首次使用时不借助文档完成 Agent 分享和安装操作
- **SC-022**: 市场 UI 与现有界面风格保持 100% 一致，无需额外的设计调整
- **SC-023**: 所有操作提供即时视觉反馈（加载状态、成功提示、错误消息），无静默失败
