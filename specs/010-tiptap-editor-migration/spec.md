# 功能规范: TipTap 编辑器迁移

**功能分支**: `010-tiptap-editor-migration`
**创建日期**: 2025-10-24
**状态**: 草稿
**用户输入**: "参考这个项目,将https://github.com/ehtisham-afzal/tiptap-shadcn集成到rafa里面去,替换掉现在的@/components/ui/editor。要求保留 /Users/wei/Coding/tiptap-editor里面完整的功能,同时保留现有的前后端架构,自动更新等,注意,只是切换editor三方依赖,不要改变其他地方"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础富文本编辑 (优先级: P1)

用户在笔记编辑器中使用所有基本富文本编辑功能,包括桌面和移动端的完整工具栏支持。

**优先级原因**: 这是核心编辑功能,没有它用户无法正常编辑笔记。必须保证迁移后编辑器的基本功能不受影响。

**独立测试**: 可以通过在笔记编辑器中创建新笔记、输入文本、应用各种格式(加粗、斜体、标题、列表等)来独立测试,并验证在桌面和移动设备上的表现。

**验收场景**:

1. **给定** 用户打开笔记编辑器, **当** 用户输入文本并使用桌面工具栏应用格式(加粗、斜体、下划线、删除线等), **那么** 文本应正确显示应用的格式
2. **给定** 用户在移动设备上打开笔记编辑器, **当** 用户选中文本, **那么** 应显示浮动工具栏,包含所有移动优化的格式选项
3. **给定** 用户在编辑器中, **当** 用户输入 `/` 字符, **那么** 应显示斜杠命令菜单,列出所有可用的块类型(标题、列表、引用、代码块等)
4. **给定** 用户选中文本, **当** 用户在浮动菜单中点击"Turn into"选择器, **那么** 应显示可用的节点类型并正确转换

---

### 用户故事 2 - 高级格式化功能 (优先级: P2)

用户使用高级编辑功能,包括颜色高亮、文本对齐、图片占位符、搜索替换等。

**优先级原因**: 这些是增强用户体验的重要功能,但不影响基本编辑能力。用户可以先使用基本编辑功能,再逐步启用这些高级特性。

**独立测试**: 可以通过创建包含各种高级格式的笔记来测试,包括彩色文本、高亮、不同对齐方式、图片和搜索替换功能。

**验收场景**:

1. **给定** 用户在编辑器中选中文本, **当** 用户从颜色选择器中选择颜色或高亮色, **那么** 文本应显示所选的颜色或高亮
2. **给定** 用户在编辑器中输入段落, **当** 用户选择文本对齐选项(左对齐、居中、右对齐), **那么** 段落应按所选方式对齐
3. **给定** 用户在工具栏中, **当** 用户点击图片占位符按钮, **那么** 应插入图片占位符到编辑器中
4. **给定** 用户在编辑器中有大量文本, **当** 用户打开搜索替换功能并输入搜索词和替换词, **那么** 应高亮显示所有匹配项并支持批量替换

---

### 用户故事 3 - 表格编辑 (优先级: P2)

用户在笔记中创建和编辑表格,包括添加/删除行列、合并单元格等高级表格操作。

**优先级原因**: 表格是组织结构化数据的重要功能,但不是所有用户都需要。可以在基本编辑功能稳定后再启用。

**独立测试**: 可以通过在编辑器中插入表格、执行各种表格操作(添加行列、删除、合并、拆分单元格)来独立测试。

**验收场景**:

1. **给定** 用户在编辑器中, **当** 用户通过斜杠命令或选择器插入表格, **那么** 应插入一个默认大小的表格(3x3,带表头行)
2. **给定** 用户光标在表格单元格中, **当** 用户点击列菜单按钮, **那么** 应显示列操作菜单(在前/后添加列、删除列、切换表头列)
3. **给定** 用户光标在表格单元格中, **当** 用户点击行菜单按钮, **那么** 应显示行操作菜单(在前/后添加行、删除行、切换表头行)
4. **给定** 用户选中多个表格单元格, **当** 用户点击合并单元格按钮, **那么** 单元格应正确合并
5. **给定** 用户在已合并的单元格中, **当** 用户点击拆分单元格按钮, **那么** 单元格应正确拆分

---

### 用户故事 4 - Markdown 支持与自动保存集成 (优先级: P1)

用户的编辑内容自动以 Markdown 格式保存,并与现有的自动保存和 embedding 功能无缝集成。

**优先级原因**: 这是关键的数据持久化功能,必须确保用户的编辑内容不会丢失,且与现有的后端架构兼容。

**独立测试**: 可以通过编辑笔记、等待自动保存触发、刷新页面验证内容是否正确恢复来测试。

**验收场景**:

1. **给定** 用户在编辑器中输入和格式化内容, **当** 20秒后(默认保存防抖时间), **那么** 应触发自动保存,内容以 Markdown 格式存储
2. **给定** 用户继续编辑, **当** 30秒后(默认 embedding 防抖时间), **那么** 应触发自动 embedding
3. **给定** 用户编辑笔记后离开页面, **当** 用户返回相同笔记, **那么** 应从 Markdown 格式正确恢复所有内容和格式
4. **给定** 自动保存或 embedding 失败, **当** 错误发生, **那么** 应显示适当的错误提示(使用现有的 alert 系统)
5. **给定** 用户切换到不同笔记, **当** 路由参数改变, **那么** 应取消待处理的保存/embedding 操作并加载新笔记内容

---

### 用户故事 5 - 字符数统计显示 (优先级: P3)

用户在编辑时可以看到实时的字符数统计。

**优先级原因**: 这是有用的辅助信息,但不影响核心编辑功能。可以最后实现。

**独立测试**: 可以通过在编辑器中输入文本并观察字符数显示来测试。

**验收场景**:

1. **给定** 用户在编辑器中, **当** 用户输入或删除文本, **那么** 字符数统计应实时更新并显示在浮动菜单中
2. **给定** 编辑器有字符数限制(可选), **当** 用户接近或超过限制, **那么** 应提供视觉反馈

---

### 边界情况

- 当用户在表格编辑模式下按下斜杠键时,不应触发斜杠命令菜单(应只在段落等文本节点中触发)
- 当用户快速切换笔记时,应正确取消待处理的保存/embedding 操作,避免数据覆盖
- 当用户在移动设备上编辑长内容时,浮动工具栏应保持可访问性和响应性
- 当用户粘贴来自其他应用的富文本时,应正确转换为 Markdown 格式
- 当用户在代码块中输入 `/` 时,不应触发斜杠命令(代码块内应保持纯文本)
- 当表格操作导致无效结构时(如删除最后一列),应防止操作或自动修复表格
- 当用户在编辑器为空时点击容器,应正确聚焦到编辑器
- 当初始内容为空字符串时,编辑器应正确初始化并显示占位符文本

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须保留现有的所有编辑器功能,包括:文本格式化(加粗、斜体、下划线、删除线、上标、下标)、标题(H1-H3)、列表(有序、无序、任务列表)、引用、代码块、表格、链接
- **FR-002**: 系统必须提供桌面工具栏,显示所有编辑功能,按功能分组并用分隔符分隔
- **FR-003**: 系统必须在移动设备上提供浮动工具栏(BubbleMenu),在用户聚焦编辑器时显示,包含所有关键格式选项
- **FR-004**: 系统必须支持斜杠命令(`/`),在用户输入 `/` 时显示可搜索的命令菜单,支持键盘导航(上下箭头、Enter、Escape)
- **FR-005**: 系统必须支持选中文本时的浮动菜单(BubbleMenu),提供快速格式化和节点类型转换
- **FR-006**: 系统必须支持表格功能,包括:插入表格、添加/删除行列、合并/拆分单元格、切换表头行/列、删除表格
- **FR-007**: 系统必须支持 Markdown 格式的输入和输出,包括粘贴时转换和复制时转换
- **FR-008**: 系统必须集成现有的自动保存功能(`useAutoSaveNote`),在用户编辑后触发防抖保存
- **FR-009**: 系统必须集成现有的 embedding 功能,在内容更新后触发防抖 embedding
- **FR-010**: 系统必须显示保存状态指示器(已保存、未保存、错误)和 embedding 状态指示器
- **FR-011**: 系统必须在编辑器中显示实时字符数统计
- **FR-012**: 系统必须支持颜色选择和文本高亮功能
- **FR-013**: 系统必须支持文本对齐(左对齐、居中、右对齐)
- **FR-014**: 系统必须支持图片占位符功能
- **FR-015**: 系统必须支持搜索和替换功能
- **FR-016**: 系统必须支持代码高亮(使用 lowlight,支持所有语言)
- **FR-017**: 系统必须在路由切换时取消待处理的保存和 embedding 操作
- **FR-018**: 系统必须保留现有的错误处理机制,使用 `showAlert` 显示错误
- **FR-019**: 系统必须支持编辑器占位符文本配置
- **FR-020**: 系统必须支持撤销/重做功能(桌面工具栏)
- **FR-021**: 系统必须支持点击编辑器容器区域自动聚焦到编辑器末尾
- **FR-022**: 系统必须保持现有的标题输入框功能和自动聚焦行为

### 关键实体

- **EditorContent**: 笔记的富文本内容,以 Markdown 字符串格式存储和传输
- **EditorState**: 编辑器的当前状态,包括光标位置、选区、激活的格式等
- **ToolbarButton**: 工具栏按钮,表示一个编辑命令(如加粗、插入链接等),包含图标、提示文本、激活状态检测和命令执行逻辑
- **SlashCommand**: 斜杠命令项,包含标题、描述、图标、搜索关键词和执行命令
- **TableMenu**: 表格操作菜单,包含列菜单、行菜单和全局菜单,根据光标位置动态显示

## 成功标准 *(必填)*

### 可测量的成果

- **SC-001**: 用户可以使用所有现有的编辑功能,迁移不导致任何功能缺失
- **SC-002**: 桌面用户可以通过工具栏访问所有20+编辑功能,分为6个功能组
- **SC-003**: 移动用户可以通过浮动工具栏访问所有关键格式选项,在编辑器聚焦时自动显示
- **SC-004**: 用户可以在1秒内通过斜杠命令找到并执行所需的块类型转换(支持模糊搜索)
- **SC-005**: 编辑器内容在20秒后(可配置)自动保存为 Markdown 格式,无数据丢失
- **SC-006**: 编辑器内容在30秒后(可配置)自动触发 embedding,支持语义搜索
- **SC-007**: 用户在任何笔记中编辑的内容,在刷新或重新打开后完全恢复,包括所有格式
- **SC-008**: 表格操作(添加行列、合并单元格等)在用户执行后立即生效,无延迟或错误
- **SC-009**: 现有的 `NoteEditor` 组件 API 保持不变,迁移对组件使用者透明
- **SC-010**: 编辑器在桌面和移动设备上的响应时间保持在100ms以内(输入到显示的延迟)
- **SC-011**: 字符数统计在用户每次输入时实时更新,无可见延迟
- **SC-012**: 搜索替换功能在包含1000+字符的文档中仍能在1秒内完成搜索和高亮

## 范围

### 包含在内

- 将 `@/components/ui/editor` 从现有实现迁移到参考项目的 tiptap-shadcn 实现
- 保留所有现有的编辑器功能和 API
- 保持与现有的 `NoteEditor` 组件的兼容性
- 保持与 `useAutoSaveNote` hook 的集成
- 添加参考项目提供的额外功能(EditorToolbar, FloatingToolbar, TipTapFloatingMenu, 搜索替换等)
- 确保桌面和移动端的完整支持
- 保持 Markdown 格式的输入输出
- 迁移所有必要的样式文件(tiptap.css)
- 迁移所有工具栏组件和扩展

### 不包含在内

- 修改 `NoteEditor` 组件的外部 API 或 props
- 修改自动保存和 embedding 的业务逻辑
- 修改后端 API 或数据存储格式
- 添加参考项目未提供的新功能
- 修改笔记列表、侧边栏或其他非编辑器相关的 UI
- 更改路由或导航逻辑
- 修改其他组件或模块

## 假设

- 参考项目的所有组件与 rafa 的现有依赖(React 18, TypeScript, shadcn/ui)兼容
- 参考项目的 `RichTextEditor` 组件支持 `onUpdate` 回调,可以集成现有的自动保存逻辑
- 参考项目使用的 tiptap 扩展与 rafa 现有的 `tiptap-markdown` 包兼容或可替代
- 现有的 Markdown 数据格式可以被新编辑器正确解析和渲染
- 所有参考项目的依赖包与 rafa 的现有版本兼容或可安全升级
- 参考项目的样式(tiptap.css)与 rafa 的全局样式和主题系统兼容

## 依赖

- **内部**: `useAutoSaveNote` hook, `useAlert` hook, `Input` 组件(标题输入框), shadcn/ui 组件库
- **外部**: 参考项目的所有 tiptap 相关依赖: `@tiptap/core`, `@tiptap/react`, `@tiptap/starter-kit`, `@tiptap/extension-color`, `@tiptap/extension-highlight`, `@tiptap/extension-image`, `@tiptap/extension-link`, `@tiptap/extension-placeholder`, `@tiptap/extension-subscript`, `@tiptap/extension-superscript`, `@tiptap/extension-text-align`, `@tiptap/extension-text-style`, `@tiptap/extension-typography`, `@tiptap/extension-underline`, `lowlight`, `tippy.js`, `fuse.js`
- **数据**: 现有的笔记 Markdown 数据必须与新编辑器兼容

## 风险

- **兼容性风险**: 参考项目的组件可能与 rafa 的现有样式或主题系统冲突,需要进行 CSS 调整
- **数据格式风险**: 新编辑器生成的 Markdown 格式可能与现有格式略有不同,可能导致旧笔记解析问题
- **性能风险**: 增加的工具栏组件和扩展可能影响编辑器性能,特别是在移动设备上
- **依赖冲突风险**: 参考项目依赖的 tiptap 版本可能与 rafa 现有版本冲突,需要升级或降级
- **回归风险**: 迁移可能意外破坏现有的编辑器功能或自动保存逻辑

**缓解措施**:
- 在迁移前对所有编辑器功能进行完整的回归测试
- 使用现有的 Markdown 数据进行渲染测试,确保向后兼容
- 在开发分支中进行充分测试后再合并到主分支
- 保留旧编辑器代码作为备份,以防需要回滚

## 备注

- 参考项目 `/Users/wei/Coding/tiptap-editor` 提供了完整的 tiptap 集成示例,包括所有工具栏组件、扩展和样式
- 重点关注保持 `NoteEditor` 组件的现有 API,确保迁移对上层组件透明
- 确保新编辑器的 `onUpdate` 回调正确触发自动保存逻辑
- 移动端的浮动工具栏(FloatingToolbar)是新增功能,需要确保在小屏幕上的可用性
- 桌面端的固定工具栏(EditorToolbar)是新增功能,需要确保不影响编辑器的可用空间
- 斜杠命令菜单(TipTapFloatingMenu)是增强功能,需要确保不与现有的键盘快捷键冲突
- 现有的 `@/components/ui/editor` 使用的是 shadcn 自定义实现,而参考项目使用的是更完整的组件化实现
- 需要将参考项目中的 `components/tiptap` 目录整体迁移到 rafa 项目中
