# 功能规格说明：侧边栏导航选中状态

**功能分支**: `003-sidebar-selection-fix`
**创建时间**: 2025-10-19
**状态**: 草稿
**输入**: 用户描述: "帮我修复左侧边栏的选中逻辑
目前已经实现的：
1. 一级导航chat, note, knowledge base, market place点击后，会渲染二级导航，chat list, note list, knowledge base list, agent list和对应的一级导航初始页面
2. 二级导航chat list, note list, knowledge base list, agent list点击后会展示对应的详情页
需要优化的：
1. 二级导航没有选中状态，用户点击二级导航，例如chat list时，要选中对应的标签，告诉用户目前他所渲染的是哪个chat
2. 用tanstack router重构一下当前的路由，看一下有没有可以改善的地方"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 当前项目的视觉反馈 (优先级: P1)

作为用户，当我在二级导航列表中点击特定的聊天/笔记/知识库时，我需要清晰的视觉反馈显示哪个项目当前处于活动状态，这样我就能始终知道自己正在查看什么内容。

**优先级原因**: 这是阻止用户自信导航的核心可用性问题。没有活动状态指示器，用户会失去在应用程序中的位置感，特别是在多个项目之间切换时。

**独立测试**: 可以通过点击聊天项目并验证被点击的项目显示活动样式（例如，高亮背景、不同颜色）而其他项目保持正常状态来完全测试。通过改善用户定位立即提供价值。

**验收场景**:

1. **假设** 我正在查看聊天列表，**当** 我点击特定聊天项目，**那么** 该聊天项目显示活动样式并在查看其内容时保持高亮
2. **假设** 我正在查看聊天 A 的内容，**当** 我通过点击导航到聊天 B，**那么** 聊天 B 变为高亮状态且聊天 A 的高亮被移除
3. **假设** 我正在查看聊天详情页，**当** 我查看侧边栏中的聊天列表，**那么** 对应的聊天项目显示与当前 URL 匹配的活动状态
4. **假设** 我通过 URL 直接导航到聊天（例如，书签或浏览器后退），**当** 页面加载时，**那么** 侧边栏中对应的聊天项目显示活动状态
5. **假设** 我正在查看笔记详情页，**当** 我查看笔记列表，**那么** 活动的笔记被清晰高亮
6. **假设** 我正在查看知识库详情页，**当** 我查看知识库列表，**那么** 活动的知识库被清晰高亮

---

### 用户故事 2 - 跨区域一致的导航状态 (优先级: P2)

作为用户，我期望所有导航区域（聊天、笔记、知识库、市场）的视觉行为保持一致，这样无论我在哪个区域，我都能预测界面的工作方式。

**优先级原因**: 一致性防止用户困惑并减少认知负担。一旦用户在一个区域学会了导航模式，他们应该能够将其应用到所有其他区域而无需重新学习。

**独立测试**: 可以通过在所有四个区域（聊天、笔记、知识库、市场）中导航并验证活动状态行为在每个区域中都相同来测试。通过确保连贯的用户体验提供价值。

**验收场景**:

1. **假设** 我在不同区域点击项目，**当** 我观察活动状态样式，**那么** 所有区域使用相同的视觉处理（颜色、背景、边框）
2. **假设** 我使用浏览器的前进/后退按钮导航，**当** 我返回到先前查看的项目，**那么** 活动状态在所有区域正确反映当前 URL
3. **假设** 我在查看项目详情时刷新页面，**当** 页面重新加载，**那么** 活动状态在所有区域的侧边栏中得以保留

---

### 用户故事 3 - 路由结构优化 (优先级: P3)

作为开发者/维护者，我需要一个更清晰、更一致的路由结构，遵循 TanStack Router 最佳实践，这样代码库更容易理解、维护和扩展。

**优先级原因**: 虽然这改善了开发者体验和长期可维护性，但不会直接影响最终用户功能。这对于减少技术债务很重要，但优先级低于面向用户的改进。

**独立测试**: 可以通过审查路由文件结构、检查路由类型安全性以及验证重构后所有导航仍然正常工作来测试。通过简化未来功能开发提供价值。

**验收场景**:

1. **假设** 开发者审查路由结构，**当** 他们检查文件组织，**那么** 相关路由被一致地分组并遵循可预测的命名模式
2. **假设** 路由结构使用 TanStack Router 功能，**当** 在路由之间导航，**那么** 类型安全得以保留，TypeScript 能捕获无效的导航尝试
3. **假设** 重构后的路由在适当的地方使用 loader，**当** 导航到详情页，**那么** 数据被预加载而不会出现加载状态闪烁
4. **假设** 嵌套路由共享公共布局，**当** 在区域内导航，**那么** 仅重新渲染内容区域，而不是整个布局

---

### 边缘情况

- 当用户导航到已被另一个会话删除的聊天/笔记/知识库时会发生什么（URL 指向不存在的项目）？
- 系统如何处理直接 URL 导航到深层嵌套路由（例如，直接在地址栏输入 `/chat/123`）？
- 当用户在某个区域没有任何项目时会发生什么（空聊天列表、空笔记列表）- 活动状态是否仍然正常工作？
- 系统如何处理快速导航（用户快速连续点击多个项目）- 活动状态是否跟得上或会产生视觉故障？
- 当 URL 参数格式错误或无效时会发生什么（例如，`/chat/invalid-id`）？
- 当在主导航区域之间转换时（例如，从聊天到笔记），活动状态如何表现 - 是否正确清除先前的活动状态？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 二级导航项目（聊天列表、笔记列表、知识库列表、市场代理列表）必须在查看对应详情页时显示视觉活动状态
- **FR-002**: 活动状态必须通过比较当前 URL 与每个项目的导航路径来确定
- **FR-003**: 每个二级导航列表一次只能有一个项目被高亮为活动状态
- **FR-004**: 当用户通过点击导航到不同项目时，活动状态必须立即更新
- **FR-005**: 当用户使用浏览器的前进/后退按钮导航时，活动状态必须正确保持
- **FR-006**: 当用户在查看详情页时刷新页面，活动状态必须正确恢复
- **FR-007**: 活动状态样式必须在所有四个区域（聊天、笔记、知识库、市场）保持一致
- **FR-008**: 路由结构必须遵循 TanStack Router 基于文件的路由约定和一致的命名
- **FR-009**: 详情路由必须在适当的地方使用 TanStack Router loader 预取数据（聊天消息、笔记内容、知识库详情）
- **FR-010**: 必须使用路由组来组织相关路由并共享公共布局
- **FR-011**: 导航链接必须使用 TanStack Router 的类型安全 Link 组件以防止无效路由
- **FR-012**: 系统必须优雅地处理导航到不存在项目的情况，并提供适当的错误状态

### 关键实体 *(如果功能涉及数据则包含)*

- **导航项目**: 表示二级导航列表中的任何可点击项目
  - 属性: ID、名称/标题、URL 路径、收藏状态（可选）
  - 关系: 属于主区域（聊天/笔记/知识库/市场）

- **活动状态**: 表示导航项目的当前选中状态
  - 属性: 项目 ID、区域类型、应用的视觉样式
  - 派生自: 当前 URL 路径与项目导航路径的匹配

## 成功标准 *(必填)*

### 可衡量的成果

- **SC-001**: 用户可以在 1 秒内通过查看侧边栏识别出他们当前正在查看哪个聊天/笔记/知识库
- **SC-002**: 活动状态在 100% 的时间内正确反映当前 URL，包括浏览器导航和页面刷新
- **SC-003**: 导航感觉即时，活动状态在路由更改后 100 毫秒内更新
- **SC-004**: 所有四个导航区域（聊天、笔记、知识库、市场）表现出相同的活动状态行为，减少用户困惑
- **SC-005**: 路由结构遵循一致的模式，使新开发者定位路由文件的速度提高 50%
- **SC-006**: 类型安全路由防止无效导航尝试，在编译时而不是运行时捕获错误
