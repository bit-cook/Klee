# Rafa 项目宪章

<!--
同步影响报告 - Constitution v1.2.0
========================================

版本变更: 1.1.0 → 1.2.0
变更理由: 添加中英文分离原则，明确开发层面使用中文，UI 层面使用英文

修改的章节:
- 核心原则：新增第 VIII 条原则

新增原则:
- VIII. 中英文分离原则：开发层面（代码注释、AI 对话、文档）使用中文，UI 层面（UI 文本、错误提示、用户可见消息）使用英文

修改的原则: 无

移除章节: 无

需要更新的模板:
- ⚠️ plan-template.md: 需要在代码标准部分强调语言使用规范
- ⚠️ spec-template.md: 需要在 UI 设计和技术约束部分明确语言要求
- ⚠️ tasks-template.md: 任务描述应遵循中英文分离原则

命令文件状态:
- ⚠️ 所有 speckit 命令需要审查，确保 AI 生成的内容符合语言规范

后续待办事项:
- 更新相关模板以反映语言使用规范
- 审查现有代码库，确保符合新原则

延迟占位符: 无
========================================
-->

<!--
同步影响报告 - Constitution v1.1.0
========================================

版本变更: 1.0.0 → 1.1.0
变更理由: 将宪章内容翻译为中文，提升中文开发者的可读性和理解度

修改的章节:
- 所有核心原则翻译为中文
- 所有开发标准翻译为中文
- 所有治理规则翻译为中文

修改的原则:
- I. Type-First Development → I. 类型优先开发
- II. Schema-Driven Architecture → II. 模式驱动架构
- III. Modular Utilities → III. 模块化工具函数
- IV. Middleware Composition → IV. 中间件组合
- V. Multi-Tenant Isolation → V. 多租户隔离
- VI. Data Integrity & Cascading → VI. 数据完整性与级联
- VII. Defensive Configuration → VII. 防御性配置

新增章节: 无

移除章节: 无

需要更新的模板:
- ✅ plan-template.md: 宪章检查部分已引用此文件
- ✅ spec-template.md: 需求部分与类型安全和测试原则保持一致
- ✅ tasks-template.md: 任务组织支持模块化开发方法

命令文件状态:
- ✅ 所有 speckit 命令已审查，确保通用指导（未发现特定代理引用）

后续待办事项: 无

延迟占位符: 无
========================================
-->

## 核心原则

### I. 类型优先开发

所有 API 必须使用 Hono RPC 实现端到端的类型安全。后端路由导出其类型（`AppType`），前端客户端自动派生请求/响应类型。当可以使用自动类型推断时，禁止手动定义类型。

**理由**: 类型安全可以防止整类运行时错误，并确保客户端-服务器契约的完整性，无需手动同步开销。

### II. 模式驱动架构

数据库模式是唯一的真实来源。Drizzle ORM 模式必须生成验证器（通过 drizzle-zod）和 TypeScript 类型。禁止在验证器或类型文件中重复定义模式。

**理由**: 维护单一真实来源可以消除数据库结构、验证逻辑和类型定义之间的漂移，减少错误和维护负担。

### III. 模块化工具函数

库函数必须设计为可组合和可跨模块（聊天、知识库、笔记）重用。函数应执行单一职责并暴露清晰的接口，可以组合成工作流。

**理由**: 可组合的工具函数减少代码重复，提高可测试性，并通过组合现有构建块实现快速功能开发。

### IV. 中间件组合

横切关注点（认证、验证、错误处理）必须使用 Hono 的组合模型实现为中间件层。路由处理器中的业务逻辑应仅关注领域操作。

**理由**: 中间件组合创建可重用、可测试的层，可以在路由间一致地应用，确保统一的安全性和错误处理。

### V. 多租户隔离

所有用户范围的数据必须包含 `userId` 列。数据库查询必须按 `userId` 过滤以防止跨用户访问。没有共享资源应该在没有显式授权检查的情况下可访问。

**理由**: 多租户隔离是不可协商的安全要求。由于缺少租户过滤而导致的数据泄露可能会产生严重的法律和声誉后果。

### VI. 数据完整性与级联

相关数据删除必须是原子的和级联安全的。外键关系应在适当的地方使用 `CASCADE`（例如，知识库 → 文件 → 嵌入向量）。禁止孤立数据。

**理由**: 数据一致性对应用程序可靠性至关重要。级联删除防止孤立记录，这些记录可能导致查询失败、存储浪费和用户困惑。

### VII. 防御性配置

外部依赖项（嵌入向量维度、API 版本、文件大小限制）必须在配置文件中使用显式值。禁止魔术数字和未记录的假设。

**理由**: 显式配置防止外部 API 更改时的静默失败，并使系统行为可预测和可调试。

### VIII. 中英文分离原则

开发层面（代码注释、AI 对话、文档）必须使用中文，因为开发团队为中文母语者。用户界面层面（UI 文本、错误提示、用户可见消息）必须使用英文，因为目标用户群体为英文使用者。

**理由**: 使用母语进行开发沟通可以提高团队协作效率和代码可读性。同时，使用目标用户的语言设计 UI 可以提供更好的用户体验和产品国际化能力。

## 开发标准

### 代码组织

- **配置集中化**: 所有环境特定值必须驻留在专用配置文件中（例如，`storage.config.ts`）
- **查询隔离**: 数据库操作必须组织在 `server/db/queries/` 目录中，不得分散在路由处理器中
- **基于功能的模块**: 前端代码必须按功能（chat、knowledge-base、notes）组织，具有专用的 hooks、组件和路由

### 测试要求

- **类型验证**: 所有用户输入必须在处理之前针对 Zod 模式进行验证
- **错误边界**: 非关键故障（例如，RAG 检索）不得破坏核心功能（需要优雅降级）
- **集成点**: 对共享工具函数（嵌入、文件处理、存储）的更改需要集成测试

### 性能标准

- **向量搜索**: 知识库嵌入向量必须使用 pgvector 和 HNSW 索引以实现低于 100 毫秒的查询性能
- **会话缓存**: 认证会话必须使用 5 分钟 TTL 缓存以减少 Auth API 调用
- **流式响应**: AI 聊天响应必须使用服务器发送事件（SSE）进行实时令牌流式传输

## 治理

### 修订程序

1. **提案**: 宪章变更必须提出明确的理由和影响分析
2. **版本升级**: 变更必须遵循语义版本控制：
   - **MAJOR（主版本）**: 向后不兼容的原则移除或重新定义
   - **MINOR（次版本）**: 新原则或实质性扩展指导
   - **PATCH（补丁版本）**: 澄清、措辞修正、非语义改进
3. **同步影响报告**: 所有修订必须在此文件顶部包含 HTML 注释，记录版本变更、修改的原则和受影响的模板
4. **模板传播**: 影响模板的更改必须在批准前更新 plan-template.md、spec-template.md 和 tasks-template.md

### 合规审查

- 所有拉取请求必须验证是否符合适用原则
- 宪章违规必须在 plan.md 的复杂性跟踪部分中记录并提供理由
- 使用 `.specify/memory/constitution.md` 作为开发期间的权威参考

### 活文档

本宪章随项目演进。鼓励定期审查以确保原则与项目需求保持一致。无法证明合理的复杂性必须重构或删除。

**版本**: 1.2.0 | **批准日期**: 2025-10-18 | **最后修订**: 2025-10-18
